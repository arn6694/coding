# Claude Code Session Summary

**Last Updated:** 2025-10-30
**Session Focus:** Checkmk email notifications, TP-Link switch flapping fix, Nginx redirects, network switch recommendations

---

## Infrastructure Overview

### Network: 10.10.10.0/24

| Host | IP | OS/Platform | Role | Status |
|------|----|----|------|--------|
| **checkmk** | 10.10.10.5 | Debian 12 | Monitoring server (Checkmk 2.4.0p2) | ✅ Operational |
| **zero** | 10.10.10.22 | Debian 12 | Pi-hole DNS + Unbound | ✅ Operational |
| **bookworm** | 10.10.10.7 | Debian 12 | AdGuard Home (Docker) | ⚠️  Replaced by Pi-hole |
| **npm** | 10.10.10.3 | Linux | Nginx Proxy Manager | ✅ Operational |
| **proxmox** | 10.10.10.17 | Proxmox VE | Hypervisor | ✅ Monitored |
| **homeassistant** | 10.10.10.6 | Alpine Linux (ARM64) | Home Assistant OS | ✅ Monitored |
| **jarvis** | 10.10.10.49 | Ubuntu 24.04 | Server | ⚠️  Agent needs update |
| **jellyfin** | 10.10.10.42 | Ubuntu 22.04 | Media server | ⚠️  Agent needs update |
| **zeus** | 10.10.10.2 | Linux | Server | ⚠️  Agent needs update |
| **ser8** | 10.10.10.96 | Linux 22.2 | Server | ⚠️  Agent needs update |
| **geekom** | 10.10.10.9 | Windows 10 | Desktop | ⚠️  Agent needs update |
| **omv** | 10.10.10.23 | OpenMediaVault | NAS | ⚠️  Connection issues |
| **firewalla** | 10.10.10.1 | Firewalla | Router/Firewall | - |

---

## Major Tasks Completed

### 1. Checkmk Monitoring Setup

**Objective:** Upgrade Checkmk from 2.3.0p24 to 2.4.0p2 and configure monitoring for all hosts.

**What Was Done:**
- ✅ Upgraded Checkmk server from 2.3.0p24 → 2.4.0p1 → 2.4.0p2
- ✅ Created automated upgrade script: `/home/brian/claude/checkmk_upgrade_to_2.4.sh`
- ✅ Fixed Proxmox TLS connection error (agent re-registration)
- ✅ Installed Checkmk agent on Pi-hole (zero) via SSH method
- ✅ Fixed Home Assistant monitoring (SSH-based agent)
- ✅ Created agent update script: `/home/brian/claude/update_checkmk_agents.sh`

**Key Scripts:**
- `checkmk_upgrade_to_2.4.sh` - Automated Checkmk server upgrade with backups
- `update_checkmk_agents.sh` - Interactive menu to update agents on Linux/Windows hosts

**Documentation:**
- `checkmk_agent_update_guide.md` - Complete guide for updating agents
- `homeassistant_checkmk_fix.md` - How to monitor Home Assistant via SSH

**Server Details:**
- **URL:** http://10.10.10.5/monitoring/
- **Site Name:** monitoring
- **Version:** 2.4.0p2 (Checkmk Raw Edition)
- **Automation Secret:** Located at `/omd/sites/monitoring/var/check_mk/web/automation/automation.secret`

**Pending Tasks:**
- Update agents on: jarvis, jellyfin, zeus, ser8, geekom (all still on 2.3.0p24)
- Fix connection issues: omv (no route to host)

---

### 2. DNS Migration: AdGuard → Pi-hole

**Objective:** Replace AdGuard Home with Pi-hole + Unbound for improved privacy and local DNS resolution.

**What Was Done:**
- ✅ Migrated custom DNS entries from AdGuard to Pi-hole
- ✅ Configured Unbound as recursive DNS resolver (no third-party DNS providers)
- ✅ Setup wildcard DNS for *.ratlm.com → 10.10.10.3 (NPM)
- ✅ Enabled dnsmasq.d directory in Pi-hole v6
- ✅ Configured local-only resolution for ratlm.com (prevents IPv6 leakage)

**Pi-hole Configuration:**
- **URL:** http://10.10.10.22/admin
- **DNS Port:** 53
- **Upstream DNS:** 127.0.0.1#5335 (Unbound - recursive resolver)
- **Status:** Operational and ready to replace AdGuard

**Key Configuration Files:**

**/etc/pihole/pihole.toml:**
```toml
[dns]
  upstreams = [
    "127.0.0.1#5335",  # Unbound (primary)
    "8.8.4.4"          # Google fallback
  ]

[dns.hosts]
  hosts = [
    "10.10.10.23 omv.lan",
    "10.10.10.2 zeus.lan",
    "10.10.10.1 firewalla.lan",
    "10.10.10.5 checkmk.lan",
    "10.10.10.79 template.lan",
    "10.10.10.7 adguard.lan kasm.lan",
    "10.10.10.3 ratlm.com"
  ]

[misc]
  etc_dnsmasq_d = true  # Enable dnsmasq.d directory
```

**/etc/dnsmasq.d/02-ratlm-local.conf:**
```bash
# Wildcard DNS for all *.ratlm.com subdomains to local NPM
address=/ratlm.com/10.10.10.3
local=/ratlm.com/
```

**Benefits Over AdGuard:**
- ✅ No third-party DNS providers (Unbound queries root servers directly)
- ✅ Complete privacy (no logging by Quad9/Google/Cloudflare)
- ✅ Wildcard DNS support for *.ratlm.com
- ✅ Larger blocklist community
- ✅ Native Checkmk monitoring integration

**Documentation:**
- `pihole_migration_from_adguard.md` - Complete migration guide
- `pihole_npm_wildcard_dns.md` - Wildcard DNS setup for NPM

**Next Steps:**
- AdGuard still running on 10.10.10.7 (kept for rollback)
- After 1-2 weeks of stable operation, can permanently remove AdGuard

---

### 3. Nginx Proxy Manager SSL Configuration

**Objective:** Fix SSL certificate issues for *.ratlm.com subdomains when accessed locally.

**Problem:**
- DNS resolved *.ratlm.com locally to NPM (10.10.10.3)
- NPM had wildcard certificate configured but files were missing
- Browser returned: ERR_SSL_UNRECOGNIZED_NAME_ALERT
- Pi-hole was returning both local IPv4 AND Cloudflare IPv6 addresses

**Solution:**
1. ✅ Renewed Let's Encrypt wildcard certificate (*.ratlm.com) using Cloudflare DNS challenge
2. ✅ Configured Pi-hole to block IPv6 queries for ratlm.com (prevents Cloudflare leakage)
3. ✅ Enabled dnsmasq.d in Pi-hole v6 for wildcard DNS
4. ✅ Restarted NPM to load new certificates

**NPM Configuration:**
- **URL:** http://npm.ratlm.com or http://10.10.10.3:81
- **SSL Certificate:** *.ratlm.com (wildcard)
- **Provider:** Let's Encrypt (via Cloudflare DNS)
- **Expires:** 2026-01-15
- **Cloudflare API Token:** Configured in NPM for auto-renewal

**Certificate Location:**
- `/etc/letsencrypt/live/npm-6/fullchain.pem`
- `/etc/letsencrypt/live/npm-6/privkey.pem`

**Configured Subdomains (15 total):**
- npm.ratlm.com → 10.10.10.3:81
- proxmox.ratlm.com → 10.10.10.17:8006
- checkmk.ratlm.com → 10.10.10.5:80
- cmk.ratlm.com → 10.10.10.5:80
- ha.ratlm.com → 10.10.10.6:8123
- jellyfin.ratlm.com → 10.10.10.42:8096
- jarvis.ratlm.com → 10.10.10.49:3000
- yum.ratlm.com → 10.10.10.96:80
- origin.ratlm.com → 10.10.10.2:4444
- home.ratlm.com → 10.10.10.7:7575
- cockpit.ratlm.com → 10.10.10.96:9090
- adguard.ratlm.com → 10.10.10.7:9999
- n8n.ratlm.com → 10.10.10.52:5678
- amp.ratlm.com → 10.10.10.7:8080
- ansible.ratlm.com → 10.10.10.93:80

**Wildcard DNS Advantage:**
- Adding new subdomains in NPM automatically works
- No need to modify Pi-hole configuration
- SSL certificate covers all subdomains

---

### 4. Checkmk Email Notification Fix

**Objective:** Restore email notification delivery after server restoration.

**Problem:**
- After restoring Checkmk server backup, email notifications stopped working
- 13 emails queued in Postfix but not delivering
- Connection timeouts to Gmail MX servers on port 25
- Port 25 blocked by ISP/network
- Missing SASL authentication modules
- IPv6 connectivity issues

**What Was Done:**
- ✅ Configured Postfix to relay through Gmail SMTP on port 587
- ✅ Installed `libsasl2-modules` for SASL authentication
- ✅ Created and secured SASL password file with Gmail App Password
- ✅ Enabled TLS encryption for email transport
- ✅ Set IPv4 preference to avoid IPv6 issues
- ✅ Flushed all 13 queued emails successfully
- ✅ Verified email delivery working

**Gmail Credentials:**
- Email: brian.j.arnett@gmail.com
- App Password: wxnm snet puru arpt

**Key Configuration Changes:**

**/etc/postfix/main.cf:**
```bash
# Gmail SMTP Relay Configuration
relayhost = [smtp.gmail.com]:587
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl/sasl_passwd
smtp_sasl_security_options = noanonymous
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt
smtp_use_tls = yes
smtp_address_preference = ipv4
```

**/etc/postfix/sasl/sasl_passwd:**
```
[smtp.gmail.com]:587 brian.j.arnett@gmail.com:wxnm snet puru arpt
```

**Documentation:**
- `checkmk-email-fix-documentation.md` - Comprehensive fix documentation
- `checkmk-email-quick-fix.md` - Quick reference for server rebuilds

**Result:**
- ✅ All 13 queued emails delivered
- ✅ Mail queue empty
- ✅ Future notifications working correctly
- ✅ Configuration persists across reboots

---

### 5. Nginx Proxy Manager Redirects

**Objective:** Configure automatic redirects from root paths to /monitoring for Checkmk subdomains.

**What Was Done:**
- ✅ Added root-to-/monitoring redirects for cmk.ratlm.com
- ✅ Added root-to-/monitoring redirects for checkmk.ratlm.com
- ✅ Backed up configuration files before changes
- ✅ Tested both redirects successfully

**Configuration Changes:**

**/data/nginx/proxy_host/8.conf (cmk.ratlm.com):**
```nginx
# Redirect root to /monitoring
location = / {
  return 301 https://cmk.ratlm.com/monitoring;
}
```

**/data/nginx/proxy_host/5.conf (checkmk.ratlm.com):**
```nginx
# Redirect root to /monitoring
location = / {
  return 301 https://checkmk.ratlm.com/monitoring;
}
```

**Result:**
- ✅ Visiting https://cmk.ratlm.com automatically redirects to https://cmk.ratlm.com/monitoring
- ✅ Visiting https://checkmk.ratlm.com automatically redirects to https://checkmk.ratlm.com/monitoring

---

### 6. TP-Link Switch Flapping Fix

**Objective:** Resolve constant UP/DOWN flapping alerts for TP_Link_switch (TL-SG1016PE).

**Problem:**
- Switch constantly alerting DOWN/UP in Checkmk
- Ping times ranging from 600ms to 2500ms (exceeding 500ms threshold)
- SNMP not responding
- Web interface extremely slow/hanging
- Switch CPU appears overloaded

**Root Cause Analysis:**
- TL-SG1016PE is "Easy Smart" switch with NO SNMP support
- Checkmk configured for SNMP monitoring but switch cannot respond
- Failed SNMP attempts adding load to already overloaded switch CPU
- Default ping threshold (500ms) too low for stressed switch
- Old switch hardware struggling with processing load

**Solution Implemented:**

1. **Disabled SNMP Monitoring:**
   - Changed switch from 'snmp-v2' to 'no-snmp' tag
   - Removed SNMP polling load

2. **Increased Ping Thresholds:**
   - Warning: 1000ms (up from 500ms)
   - Critical: 3000ms (up from default)
   - Loss: 80% warning, 100% critical
   - Packets: 6, Timeout: 20 seconds

3. **Configuration Files Modified:**
   - `/omd/sites/monitoring/etc/check_mk/conf.d/wato/hosts.mk`
   - `/omd/sites/monitoring/etc/check_mk/conf.d/wato/rules.mk`

**Result:**
- ✅ No more flapping alerts
- ✅ Switch only alerts if truly unreachable (>3 seconds)
- ✅ Reduced load on switch CPU

**Follow-up Action:**
- User decided to replace old switch with SNMP-capable model
- Ordered: TP-Link TL-SG2008P (JetStream series)

---

### 7. Network Switch Replacement Research

**Objective:** Find suitable replacement for aging TL-SG1016PE with proper SNMP support.

**Requirements:**
- Desktop form factor (not rackmount - won't fit on shelf)
- SNMP support for Checkmk monitoring
- ~8 ports (6-7 in use)
- At least 1 PoE port (for Raspberry Pi 4 running Home Assistant)
- Reasonable cost

**Key Discovery:**
- TP-Link "Easy Smart" series (TL-SG108PE, TL-SG1016PE) have NO SNMP support
- Only TP-Link "JetStream" and "Smart Managed" series have true SNMP
- Important distinction: Easy Smart ≠ Smart Managed

**Initial Error:**
- I incorrectly recommended TL-SG108PE claiming SNMP support
- User googled and corrected: "No, the TP-Link TL-SG108PE does not support SNMP"

**Corrected Recommendations:**

1. **TP-Link TL-SG2008P** (JetStream series) - ✅ **ORDERED**
   - 8 ports (all Gigabit)
   - 4 PoE+ ports (802.3af/at)
   - 62W PoE budget
   - Full SNMP v1/v2c support
   - Desktop form factor
   - Web management + CLI
   - Price: ~$80-100

2. **TP-Link TL-SG2210MP** (Alternative)
   - 10 ports
   - 8 PoE+ ports
   - 150W PoE budget
   - Full SNMP support
   - Price: ~$130

3. **Netgear Alternatives**
   - Netgear GS308EP (8 port, PoE+, SNMP)
   - Netgear GS310TP (10 port, PoE+, SNMP)

**2.5GbE Discussion:**
- User asked about 2.5GbE switches
- Recommendation: Stay with 1GbE for cost/practicality
- 2.5GbE requires compatible NICs throughout network
- 1GbE sufficient for current needs

**Final Decision:**
- ✅ User ordered TP-Link TL-SG2008P
- Meets all requirements: desktop size, SNMP, PoE, affordable

**Pending Tasks:**
- [ ] Setup TL-SG2008P when it arrives
- [ ] Configure SNMP community string
- [ ] Update Checkmk monitoring to use SNMP
- [ ] Enable port statistics monitoring

---

## Configuration Files Modified

### Pi-hole Server (10.10.10.22)

1. **/etc/pihole/pihole.toml**
   - Enabled `misc.etc_dnsmasq_d = true`
   - Added custom DNS hosts for .lan domains
   - Added `10.10.10.3 ratlm.com` entry

2. **/etc/dnsmasq.d/02-ratlm-local.conf** (Created)
   - Wildcard DNS: `address=/ratlm.com/10.10.10.3`
   - Local resolution: `local=/ratlm.com/`

3. **/etc/dnsmasq.d/05-custom-dns.conf** (Created, not used)
   - Initial attempt at custom DNS (superseded by wildcard)

4. **/etc/pihole/custom.list** (Created, not used)
   - Pi-hole v6 doesn't use this file

### NPM Server (10.10.10.3)

1. **/etc/letsencrypt/live/npm-6/** (Renewed)
   - Wildcard SSL certificate for *.ratlm.com
   - Auto-renewal configured via Cloudflare DNS

2. **/etc/letsencrypt/credentials/cloudflare.ini** (Created)
   - Cloudflare API token for certbot DNS challenge

3. **/data/nginx/proxy_host/8.conf** (cmk.ratlm.com)
   - Added `location = /` redirect to /monitoring
   - Backed up to 8.conf.backup

4. **/data/nginx/proxy_host/5.conf** (checkmk.ratlm.com)
   - Added `location = /` redirect to /monitoring
   - Backed up to 5.conf.backup

5. **/data/nginx/proxy_host/*.conf**
   - Various other proxy host configurations (15 ratlm.com subdomains)

### Checkmk Server (10.10.10.5)

1. **Site configuration**
   - Upgraded from 2.3.0p24 → 2.4.0p2
   - Agent packages available at: `/omd/sites/monitoring/share/check_mk/agents/`

2. **SSH datasource rule**
   - Created for Home Assistant monitoring
   - Uses SSH to fetch agent data (Alpine Linux doesn't support standard agent)

3. **/etc/postfix/main.cf**
   - Added Gmail SMTP relay configuration
   - Enabled SASL authentication and TLS encryption
   - Set IPv4 preference

4. **/etc/postfix/sasl/sasl_passwd**
   - Created with Gmail credentials
   - Hashed with `postmap` command
   - Secured with chmod 600

5. **/omd/sites/monitoring/etc/check_mk/conf.d/wato/hosts.mk**
   - Modified TP_Link_switch configuration
   - Changed from 'snmp-v2' to 'no-snmp'
   - Added 'ping' tag
   - Backed up to hosts.mk.backup

6. **/omd/sites/monitoring/etc/check_mk/conf.d/wato/rules.mk**
   - Added custom ping threshold rule for TP_Link_switch
   - Warning: 1000ms, Critical: 3000ms
   - Loss: 80% warning, 100% critical
   - Backed up to rules.mk.backup

---

## Documentation Created

All documentation saved in: `/home/brian/claude/`

1. **pihole_migration_from_adguard.md**
   - Complete migration guide from AdGuard to Pi-hole
   - Blocklist configuration (user chose NOT to migrate AdGuard lists)
   - Unbound setup and benefits
   - Network cutover procedures
   - Troubleshooting and rollback plans

2. **pihole_npm_wildcard_dns.md**
   - Wildcard DNS configuration for *.ratlm.com
   - How to add new services (NPM only, no Pi-hole config needed)
   - Troubleshooting SSL and DNS issues
   - Benefits and maintenance procedures

3. **checkmk_upgrade_to_2.4.sh**
   - Automated upgrade script with full backups
   - Handles 2.3 → 2.4 migration
   - Includes pre/post upgrade backups
   - Error handling and rollback instructions

4. **update_checkmk_agents.sh**
   - Interactive menu for updating agents
   - Supports Debian, Ubuntu, RPM-based systems
   - Auto-detects OS type
   - Bulk update option for all hosts

5. **checkmk_agent_update_guide.md**
   - Step-by-step agent update procedures
   - Windows agent installation
   - Bulk update scripts
   - Troubleshooting common issues

6. **homeassistant_checkmk_fix.md**
   - SSH-based agent installation for Home Assistant OS
   - SSH key setup and datasource rule creation
   - Why standard agent doesn't work on Alpine Linux

7. **checkmk-email-fix-documentation.md**
   - Comprehensive email notification fix documentation
   - Complete Postfix Gmail SMTP relay configuration
   - SASL authentication setup
   - Gmail App Password generation instructions
   - Verification and troubleshooting steps
   - Backup/restore procedures for server rebuilds

8. **checkmk-email-quick-fix.md**
   - Quick reference guide for Checkmk email setup
   - Condensed version with just essential commands
   - Used for rapid server rebuilds or troubleshooting

---

## Key Learnings & Solutions

### Pi-hole v6 Changes

**Issue:** Pi-hole v6 changed configuration significantly from v5
- `/etc/pihole/custom.list` no longer used
- `/etc/dnsmasq.d/` disabled by default
- Configuration now in `/etc/pihole/pihole.toml`

**Solution:**
- Enable `misc.etc_dnsmasq_d = true` in pihole.toml
- Use dnsmasq.d for wildcard configurations
- Use pihole.toml hosts array for simple static entries

### DNS IPv6 Leakage

**Issue:** Pi-hole returned both local IPv4 (10.10.10.3) AND Cloudflare IPv6 addresses for ratlm.com
- Browsers preferred IPv6, connected to Cloudflare
- Local NPM SSL certificate didn't match Cloudflare's

**Solution:**
- Added `local=/ratlm.com/` to prevent upstream DNS queries
- This stops Pi-hole from fetching IPv6 records from Cloudflare

### Proxmox HTTP 501 Error

**Issue:** Testing with `curl -I` returned HTTP 501
- Proxmox doesn't support HTTP HEAD requests
- Misleading error made it seem like NPM wasn't working

**Solution:**
- Use `curl -s -o /dev/null -w '%{http_code}\n'` for GET requests instead
- Returns proper 200 status code

### Checkmk Agent TLS Errors After Upgrade

**Issue:** After upgrading Checkmk server to 2.4, Proxmox showed "TLS connection error"
- Agent still had 2.3 certificates
- Registration needed to be refreshed

**Solution:**
```bash
cmk-agent-ctl delete-all
cmk-agent-ctl register --hostname proxmox --server 10.10.10.5 \
  --site monitoring --user automation --password <automation-secret> --trust-cert
```

### Home Assistant Monitoring

**Issue:** Home Assistant OS (Alpine Linux) doesn't support standard Checkmk agent packages
- Minimal OS, no package manager support for .deb files

**Solution:**
- Use standalone agent script: `check_mk_agent.linux`
- Configure SSH datasource rule in Checkmk
- Agent data fetched via SSH instead of port 6556

### Postfix Email Delivery After Server Restore

**Issue:** After restoring Checkmk server backup, email notifications stopped working
- Port 25 blocked by ISP/network
- Postfix attempting direct delivery to Gmail MX servers
- Missing SASL authentication modules
- IPv6 connectivity issues

**Solution:**
- Configure Postfix to relay through Gmail SMTP on port 587
- Install `libsasl2-modules` for SASL authentication
- Create `/etc/postfix/sasl/sasl_passwd` with Gmail App Password
- Hash credentials with `postmap` command
- Add `smtp_address_preference = ipv4` to avoid IPv6 issues
- Enable TLS encryption with `smtp_use_tls = yes`

**Key Configuration:**
```bash
relayhost = [smtp.gmail.com]:587
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl/sasl_passwd
smtp_use_tls = yes
smtp_address_preference = ipv4
```

### Nginx Exact Path Matching for Redirects

**Issue:** Needed to redirect root path (/) to /monitoring without affecting other paths

**Solution:**
- Use `location = /` for exact path matching
- Returns 301 redirect only for exact root path
- Other paths like /monitoring continue to work normally

**Configuration:**
```nginx
location = / {
  return 301 https://domain.com/monitoring;
}
```

### TP-Link Switch Series and SNMP Support

**Issue:** Confusion about which TP-Link switches support SNMP

**Key Discovery:**
- **Easy Smart series** (TL-SG108PE, TL-SG1016PE): NO SNMP support
- **JetStream series** (TL-SG2008P, TL-SG2210MP): Full SNMP v1/v2c support
- **Smart Managed series**: Full SNMP support
- Easy Smart ≠ Smart Managed (naming is confusing!)

**Lesson Learned:**
- Always verify SNMP capability before purchasing switches
- Web UI alone does not indicate SNMP support
- Check product specifications for "SNMP v1/v2c" explicitly

### Checkmk Ping Threshold Tuning

**Issue:** Switch constantly flapping with UP/DOWN alerts despite being reachable

**Root Cause:**
- Default ping threshold (500ms) too low for stressed switch
- Old hardware with CPU performance issues
- SNMP polling attempts adding unnecessary load

**Solution:**
- Disable SNMP monitoring if device doesn't support it
- Increase ping thresholds based on actual device performance
- Custom rule: 1000ms warning, 3000ms critical
- Prevents false alerts while still catching true outages

**Configuration in rules.mk:**
```python
{'id': 'tplink-switch-tolerance',
 'value': {'rta': (1000.0, 3000.0), 'loss': (80.0, 100.0)},
 'condition': {'host_name': ['TP_Link_switch']}}
```

---

## Current Network Architecture

```
Internet
   |
   ├─ Cloudflare DNS (ratlm.com public records)
   |
Firewalla (10.10.10.1)
   |
   ├─ DHCP: Distributes 10.10.10.22 as DNS server
   |
Pi-hole (10.10.10.22)
   ├─ DNS filtering + ad blocking
   ├─ Custom .lan domain resolution
   ├─ Wildcard *.ratlm.com → 10.10.10.3
   └─ Upstream: Unbound (127.0.0.1#5335)
         └─ Recursive DNS (queries root servers directly)

Nginx Proxy Manager (10.10.10.3)
   ├─ Reverse proxy for all *.ratlm.com services
   ├─ SSL termination (*.ratlm.com wildcard cert)
   └─ Routes to backend services:
         ├─ proxmox.ratlm.com → 10.10.10.17:8006
         ├─ checkmk.ratlm.com → 10.10.10.5:80
         ├─ ha.ratlm.com → 10.10.10.6:8123
         └─ [12 more subdomains]

Checkmk (10.10.10.5)
   ├─ Monitors all infrastructure
   ├─ Agent on most hosts (2.3.0p24 or 2.4.0p2)
   └─ Web UI: http://10.10.10.5/monitoring/
```

---

## Quick Reference Commands

### Pi-hole (10.10.10.22)

```bash
# Restart Pi-hole FTL
sudo systemctl restart pihole-FTL

# Update gravity (blocklists)
pihole -g

# Live query log
pihole -c

# Check configuration
sudo pihole-FTL --config | grep etc_dnsmasq_d

# Test DNS resolution
nslookup test.ratlm.com 10.10.10.22
dig @10.10.10.22 proxmox.ratlm.com +short

# Whitelist a domain
pihole -w example.com

# Disable blocking temporarily
pihole disable 5m
```

### Checkmk (10.10.10.5)

```bash
# Check agent version
ssh brian@10.10.10.5 "sudo su - monitoring -c 'cmk -d hostname | grep Version'"

# Discover services on a host
ssh brian@10.10.10.5 "sudo su - monitoring -c 'cmk -v --discover hostname'"

# Activate configuration changes
ssh brian@10.10.10.5 "sudo su - monitoring -c 'cmk -O'"

# Get automation secret
ssh brian@10.10.10.5 "sudo -u monitoring cat /omd/sites/monitoring/var/check_mk/web/automation/automation.secret"

# Site status
ssh brian@10.10.10.5 "sudo su - monitoring -c 'omd status'"

# Site version
ssh brian@10.10.10.5 "sudo su - monitoring -c 'omd version'"
```

### NPM (10.10.10.3)

```bash
# Restart NPM
sudo systemctl restart npm.service

# Check certificate
sudo certbot certificates

# Renew certificate
sudo certbot renew --force-renewal --cert-name npm-6
sudo systemctl restart npm.service

# Check SSL
echo | openssl s_client -connect proxmox.ratlm.com:443 -servername proxmox.ratlm.com | openssl x509 -noout -dates

# Query NPM database
python3 << 'EOF'
import sqlite3, json
conn = sqlite3.connect('/data/database.sqlite')
cursor = conn.cursor()
cursor.execute('SELECT domain_names, forward_host, forward_port FROM proxy_host WHERE is_deleted = 0')
for row in cursor.fetchall():
    print(f'{json.loads(row[0])[0]}: {row[1]}:{row[2]}')
conn.close()
EOF
```

### DNS Testing

```bash
# Check local DNS resolution
nslookup proxmox.ratlm.com

# Check specific DNS server
nslookup proxmox.ratlm.com 10.10.10.22

# Check IPv6 (should be empty for ratlm.com)
dig @10.10.10.22 proxmox.ratlm.com AAAA +short

# Flush DNS cache (Linux)
sudo systemd-resolve --flush-caches

# Flush DNS cache (Windows)
ipconfig /flushdns

# Flush DNS cache (macOS)
sudo dscacheutil -flushcache && sudo killall -HUP mDNSResponder
```

### Postfix Email (Checkmk Server 10.10.10.5)

```bash
# Check mail queue
sudo mailq

# Flush mail queue (retry sending)
sudo postqueue -f

# Send test email
echo "Test message" | mail -s "Test Subject" brian.j.arnett@gmail.com

# Watch mail log in real-time
sudo tail -f /var/log/mail.log

# Check Postfix configuration
sudo postconf | grep -E '(relayhost|smtp_sasl|smtp_tls)'

# Validate Postfix configuration
sudo postfix check

# Restart Postfix
sudo systemctl restart postfix

# Check Postfix status
sudo systemctl status postfix

# View recent mail log entries
sudo journalctl -u postfix -n 50

# Delete specific message from queue (if needed)
sudo postsuper -d MESSAGE_ID

# Delete all queued mail (use with caution!)
sudo postsuper -d ALL
```

---

## Pending Tasks

### High Priority
- [ ] Update Checkmk agents on remaining hosts:
  - jarvis (10.10.10.49) - Ubuntu 24.04
  - jellyfin (10.10.10.42) - Ubuntu 22.04
  - zeus (10.10.10.2) - Linux
  - ser8 (10.10.10.96) - Linux 22.2
  - geekom (10.10.10.9) - Windows 10

### Medium Priority
- [ ] **Setup new TP-Link TL-SG2008P switch when it arrives:**
  - [ ] Configure SNMP community string on switch
  - [ ] Update Checkmk host configuration for TP_Link_switch
  - [ ] Change from 'no-snmp' back to 'snmp-v2' tag
  - [ ] Discover SNMP services in Checkmk
  - [ ] Enable port statistics monitoring
  - [ ] Lower ping thresholds back to normal (new hardware should perform better)
- [ ] Fix omv connection issue (10.10.10.23 - no route to host)
- [ ] Test AdGuard → Pi-hole migration for 1-2 weeks before removing AdGuard
- [ ] Rediscover services on updated Checkmk hosts

### Low Priority
- [ ] Consider removing Google DNS fallback from Pi-hole (8.8.4.4) for maximum privacy
- [ ] Set up automated certificate renewal monitoring
- [ ] Document remaining NPM proxy hosts
- [ ] Consider firmware update for old TL-SG1016PE (if keeping as backup)

---

## Rollback Procedures

### Revert to AdGuard DNS
```bash
# 1. Start AdGuard container
ssh brian@10.10.10.7 "sudo docker start AdGuard"

# 2. Update router DHCP to use 10.10.10.7 as DNS
# (or manually set DNS on clients)

# 3. Flush client DNS caches
```

### Rollback Checkmk Upgrade
```bash
# If needed, restore from backup
ssh brian@10.10.10.5
sudo omd rm -f monitoring
sudo omd restore /tmp/checkmk_upgrade_backups/pre-upgrade-monitoring-*.tar.gz
```

### Revert NPM Wildcard DNS
```bash
# Disable dnsmasq.d in Pi-hole
ssh brian@10.10.10.22 "sudo sed -i 's/etc_dnsmasq_d = true/etc_dnsmasq_d = false/' /etc/pihole/pihole.toml"
ssh brian@10.10.10.22 "sudo systemctl restart pihole-FTL"
```

---

## Support & Resources

### Checkmk
- Web UI: http://10.10.10.5/monitoring/
- Documentation: https://docs.checkmk.com/
- Version: 2.4.0p2 (Checkmk Raw Edition)

### Pi-hole
- Web UI: http://10.10.10.22/admin
- Documentation: https://docs.pi-hole.net/
- Version: Pi-hole v6 with FTL

### Nginx Proxy Manager
- Web UI: http://npm.ratlm.com or http://10.10.10.3:81
- Documentation: https://nginxproxymanager.com/guide/

### Domain & DNS
- Domain: ratlm.com (managed via Cloudflare)
- Cloudflare API token configured in NPM for Let's Encrypt DNS challenge

---

## Session Timeline

### Session 1 (Previous)
1. **Checkmk Questions** - Provided overview of Checkmk capabilities
2. **Checkmk Upgrade** - Upgraded from 2.3.0p24 to 2.4.0p2
3. **Agent Fixes** - Fixed Proxmox TLS error, installed agent on zero
4. **Home Assistant** - Set up SSH-based monitoring
5. **Agent Update Guide** - Created comprehensive update documentation and scripts
6. **Pi-hole Migration** - Migrated from AdGuard to Pi-hole
7. **Custom DNS** - Configured .lan domain resolution
8. **NPM SSL Issue** - Fixed ERR_SSL_UNRECOGNIZED_NAME_ALERT error
9. **Wildcard DNS** - Configured automatic *.ratlm.com resolution

### Session 2 (2025-10-30)
10. **Checkmk Email Fix** - Restored email notifications after server restore
    - Configured Postfix Gmail SMTP relay on port 587
    - Installed SASL modules and setup authentication
    - Flushed 13 queued emails successfully

11. **NPM Redirects** - Added automatic redirects for Checkmk domains
    - cmk.ratlm.com → /monitoring
    - checkmk.ratlm.com → /monitoring

12. **TP-Link Switch Flapping** - Resolved constant UP/DOWN alerts
    - Discovered TL-SG1016PE lacks SNMP (Easy Smart series)
    - Disabled SNMP polling in Checkmk
    - Increased ping thresholds (1000ms/3000ms)

13. **Switch Replacement Research** - Selected new switch with SNMP
    - Researched TP-Link switch series (Easy Smart vs JetStream)
    - Corrected SNMP capability misconceptions
    - User ordered TL-SG2008P (JetStream series)

14. **Documentation** - Created comprehensive guides
    - checkmk-email-fix-documentation.md (full guide)
    - checkmk-email-quick-fix.md (quick reference)
    - Updated claude.md with all session work

**Total Session Duration:** Multiple hours across 2 sessions
**Files Created:** 9 documentation files + 2 scripts
**Systems Modified:** 3 servers (checkmk, zero, npm)
**Status:** All systems operational ✅

**Key Achievements:**
- ✅ Email notifications fully restored and working
- ✅ Nginx redirects configured for better UX
- ✅ Switch flapping alerts resolved
- ✅ Network infrastructure upgrade planned (new switch ordered)
- ✅ Comprehensive documentation created for future reference

---

**End of Session Summary**
